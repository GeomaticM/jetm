<path id="doc.classpath">
  <fileset dir="${basedir}/modules/documentation/lib">
    <include name="*.jar"/>
  </fileset>
</path>

<target name="create-doc" depends="init-doc, prepare-doc" description="Creates JETM documentation">
  <antcall target="doc-html"/>
  <antcall target="doc-pdf"/>
</target>

<target name="doc-html">
  <mkdir dir="${module.doc.dest}/reference/html"/>

  <java classname="net.sf.saxon.Transform" fork="true" dir="${basedir}">
    <classpath refid="doc.classpath"/>
    <arg value="-o"/>
    <arg value="${module.doc.dest}/reference/html/index.html"/>
    <arg value="${module.doc.dest.tmp}/merged/reference.merged"/>
    <arg value="${module.doc.dest.tmp}/${module.doc.docbook.version}/html.xsl"/>
  </java>
  <copy file="${module.doc.dir}/src/shared/default.css" todir="${module.doc.dest}/reference/html"/>
</target>

<target name="doc-pdf">
  <mkdir dir="${module.doc.dest}/reference/pdf"/>

  <copy todir="${module.doc.dest.tmp}/merged">
    <fileset dir="${module.doc.dir}/src/shared">
      <include name="**/images/**" />
    </fileset>
  </copy>

  <java classname="net.sf.saxon.Transform" fork="true" dir="${basedir}">
    <classpath refid="doc.classpath"/>
    <arg value="-o"/>
    <arg value="${module.doc.dest.tmp}/merged/reference.fo"/>
    <arg value="${module.doc.dest.tmp}/merged/reference.merged"/>
    <arg value="${basedir}/${module.doc.dest.tmp}/${module.doc.docbook.version}/pdf.xsl"/>
  </java>

  <java classname="org.apache.fop.cli.Main" fork="true" dir="${basedir}">
    <jvmarg value="-Djava.awt.headless=true"/>

    <classpath refid="doc.classpath"/>
    <arg value="${module.doc.dest.tmp}/merged/reference.fo"/>
    <arg value="${basedir}/${module.doc.dest}/reference/pdf/jetm-reference.pdf"/>
  </java>
</target>


<target name="init-doc">
  <mkdir dir="${module.doc.dest}"/>


  <available property="docbook.expanded" file="${module.doc.dest.tmp}/${module.doc.docbook.version}" />
  <antcall target="expand-docbook" />

  <copy todir="${module.doc.dest.tmp}/${module.doc.docbook.version}">
    <fileset dir="${module.doc.dir}/src/style" />
  </copy>


  <!-- Create dynamic values for XSL processing -->  
  <echo file="${module.doc.dest.tmp}/${module.doc.docbook.version}/dynamic-values.xsl"><![CDATA[<?xml version="1.0"?>
<xsl:stylesheet version="2.0"
                xmlns:xsl="http://www.w3.org/1999/XSL/Transform">  
  <xsl:param name="release.date">${release.date}</xsl:param>
  <xsl:param name="release.version">${release.version}</xsl:param>
</xsl:stylesheet>
]]></echo>

</target>

<target name="clean-doc">
  <delete dir="${module.doc.dest}"/>
</target>

<target name="prepare-doc">
  <!-- process xinclude directives -->
  <mkdir dir="${module.doc.dest.tmp}/merged"/>

  <java classname="net.sf.saxon.Transform" fork="true" dir="${basedir}">
    <classpath refid="doc.classpath"/>
    <arg value="-o"/>
    <arg value="${module.doc.dest.tmp}/merged/reference.merged"/>
    <arg value="${basedir}/${module.doc.dir}/src/docbook/reference.docbook"/>
    <arg value="${basedir}/${module.doc.dest.tmp}/${module.doc.docbook.version}/xipr.xsl"/>
  </java>
</target>


<target name="expand-docbook" unless="docbook.expanded">
  <unzip src="${module.doc.dir}/contrib/${module.doc.docbook.version}.zip"
         dest="${module.doc.dest.tmp}" />
</target>

